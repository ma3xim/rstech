<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Products</title>
    <link rel="stylesheet" href="/styles.css"/>
</head>
<body>
<header>
    <a href="/categories">Категории</a>
    <button onclick="logout()">Выйти</button>
</header>
<section class="card">
    <h3>Фильтры</h3>
    <input id="qName" placeholder="Название"/>
    <select id="qCategory">
        <option value="">Все категории</option>
    </select>
    <input id="qMin" placeholder="Цена от" type="number" step="0.01"/>
    <input id="qMax" placeholder="Цена до" type="number" step="0.01"/>
    <button onclick="loadProducts()">Искать</button>
</section>
<section class="card">
    <h3>Список продуктов</h3>
    <table id="tbl">
        <thead>
        <tr>
            <th>ID</th>
            <th>Имя</th>
            <th>Категория</th>
            <th>Цена</th>
            <th>Статус</th>
            <th></th>
        </tr>
        </thead>
        <tbody></tbody>
    </table>
</section>
<script>
    const token = () => localStorage.getItem('token');

    function logout() {
        localStorage.removeItem('token');
        location.href = '/login';
    }

    async function loadProducts() {
        const params = new URLSearchParams();
        if (qName.value) params.append('name', qName.value);
        if (qCategory.value) params.append('categoryId', qCategory.value);
        if (qMin.value) params.append('minPrice', qMin.value);
        if (qMax.value) params.append('maxPrice', qMax.value);
        const res = await fetch('/api/products?' + params.toString(), {
            headers: {'Authorization': 'Bearer ' + token()}
        });
        if (!res.ok) {
            if (res.status === 401) return location.href = '/login';
            alert('Ошибка загрузки');
            return;
        }
        const data = await res.json();
        const tbody = document.querySelector('#tbl tbody');
        tbody.innerHTML = '';
        data.content.forEach(p => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${p.id}</td><td>${p.name}</td><td>${p.categoryName || ''}</td><td>${p.price}</td><td>${p.status ? 'активен' : 'неактивен'}</td>
                <td><button onclick="del(${p.id})">Удалить</button></td>`;
            tbody.appendChild(tr);
        });
    }

    async function del(id) {
        if (!confirm('Удалить продукт #' + id + '?')) return;
        const res = await fetch('/api/products/' + id, {
            method: 'DELETE',
            headers: {'Authorization': 'Bearer ' + token()}
        });
        if (res.status === 204) loadProducts(); else alert('Не удалось удалить');
    }

    async function loadCategories() {
        const res = await fetch('/api/categories', {
            headers: {'Authorization': 'Bearer ' + token()}
        });
        if (!res.ok) return alert('Не удалось загрузить категории');
        const categories = await res.json();
        const select = document.getElementById('qCategory');
        categories.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id;
            opt.textContent = c.name;
            select.appendChild(opt);
        });
    }


    loadCategories();
    loadProducts();
</script>
</body>
</html>
